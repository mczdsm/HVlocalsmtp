version: '3.8'

services:
  smtp-receiver:
    build: .
    container_name: smtp-receiver-app
    ports:
      - "1025:1025"
    volumes:
      # Mount the named volume to the path the application expects.
      # The app writes to /scans/users, so we mount the volume at /scans.
      - scan_data:/scans
      # Mount logs directory to host (outside of shared folder)
      - ./logs:/logs
    environment:
      # LOGGING_MODE: 'DEBUG' or 'PRODUCTION'.
      # - DEBUG: Verbose console logging.
      # - PRODUCTION: Separates audit and error logs into files.
      - LOGGING_MODE=PRODUCTION
      # TEST_MODE: 'true' or 'false'.
      # - true: Enables automatic sending of test emails to the server.
      - TEST_MODE=true
      # Security Configuration
      - SCANS_BASE_PATH=/scans/users
      - MAX_FILE_SIZE_MB=50
      - SMTP_HOST=0.0.0.0
      - SMTP_PORT=1025
      - LOG_PATH=/logs
    # Security hardening
    read_only: false  # Need write access for scans directory
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - FOWNER
      - DAC_OVERRIDE
      - SETUID
      - SETGID
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import socket; socket.create_connection((\"localhost\", 1025), timeout=5)'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  samba:
    build:
      context: .
      dockerfile: Dockerfile.samba
    container_name: samba-server
    # SECURITY WARNING: Change the default password before deployment!
    # Generate a strong password and replace CHANGE_THIS_PASSWORD
    environment:
      # User and group configuration for servercontainers/samba
      - ACCOUNT_winuser=TestPassword123
      - GROUP_filemanagers
      - GROUPS_winuser=filemanagers
      # Share and recycle bin configuration
      - SAMBA_VOLUME_CONFIG_scans=[scans];path=/srv/scans;valid users=@filemanagers;writable=yes;create mask=0664;directory mask=0755;force user=winuser;force group=filemanagers;vfs objects=recycle;recycle:repository=.recycle;recycle:keeptree=yes;recycle:versions=yes
      # Global Samba settings
      - SAMBA_CONF_WORKGROUP=WORKGROUP
      - SAMBA_GLOBAL_CONFIG_server_SPACE_min_SPACE_protocol=SMB2_10
    ports:
      - "139:139"
      - "445:445"
    volumes:
      # Mount the named volume to the path that the SHARE variable uses.
      - scan_data:/srv/scans
    # Security hardening
    read_only: false
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - NET_BIND_SERVICE
      - SETGID
      - SETUID
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "smbclient", "-L", "localhost", "-U%"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  scan_data:
    driver: local
